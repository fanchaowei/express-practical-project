/**
 * åº”ç”¨ç¨‹åºå…¥å£æ–‡ä»¶
 * ä½œç”¨ï¼šå¯åŠ¨ HTTP æœåŠ¡å™¨ï¼Œè¿æ¥æ•°æ®åº“ï¼Œå¤„ç†è¿›ç¨‹ä¿¡å·
 *
 * è¿™ä¸ªæ–‡ä»¶çš„æ‰§è¡Œæµç¨‹ï¼š
 * 1. éªŒè¯ç¯å¢ƒå˜é‡
 * 2. è¿æ¥æ•°æ®åº“
 * 3. å¯åŠ¨ HTTP æœåŠ¡å™¨
 * 4. ç›‘å¬è¿›ç¨‹ä¿¡å·ï¼Œä¼˜é›…å…³é—­
 */

// å¯¼å…¥é…ç½®å¥½çš„ Express åº”ç”¨
import app from './app';

// å¯¼å…¥ç¯å¢ƒé…ç½®å’ŒéªŒè¯å‡½æ•°
import { env, validateEnv } from './config/env';

// å¯¼å…¥æ•°æ®åº“è¿æ¥å‡½æ•°
import { connectDatabase, disconnectDatabase } from './config/database';

// å¯¼å…¥æ—¥å¿—å·¥å…·
import { logger } from './utils/logger';

/**
 * ============ ç¯å¢ƒå˜é‡éªŒè¯ ============
 */

/**
 * åœ¨åº”ç”¨å¯åŠ¨å‰éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
 *
 * try-catch è¯´æ˜ï¼š
 * - tryï¼šå°è¯•æ‰§è¡Œå¯èƒ½å‡ºé”™çš„ä»£ç 
 * - catchï¼šå¦‚æœå‡ºé”™ï¼Œæ•è·é”™è¯¯å¹¶å¤„ç†
 *
 * ä¸ºä»€ä¹ˆåœ¨è¿™é‡ŒéªŒè¯ï¼Ÿ
 * - å°½æ—©å‘ç°é…ç½®é—®é¢˜ï¼Œé¿å…åº”ç”¨å¯åŠ¨åæ‰æŠ¥é”™
 * - å¦‚æœç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼Œç›´æ¥é€€å‡ºç¨‹åº
 */
try {
  validateEnv();
} catch (error) {
  // è®°å½•é”™è¯¯æ—¥å¿—
  logger.error('Environment validation failed:', error);
  // é€€å‡ºç¨‹åºï¼ŒçŠ¶æ€ç  1 è¡¨ç¤ºå¼‚å¸¸é€€å‡º
  process.exit(1);
}

/**
 * ============ å¯åŠ¨æœåŠ¡å™¨å‡½æ•° ============
 */

/**
 * å¯åŠ¨æœåŠ¡å™¨çš„å¼‚æ­¥å‡½æ•°
 *
 * async å…³é”®å­—è¯´æ˜ï¼š
 * - è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°
 * - å¯ä»¥ä½¿ç”¨ await å…³é”®å­—ç­‰å¾…å¼‚æ­¥æ“ä½œ
 * - è‡ªåŠ¨è¿”å› Promise å¯¹è±¡
 *
 * ä¸ºä»€ä¹ˆä½¿ç”¨å¼‚æ­¥ï¼Ÿ
 * - è¿æ¥æ•°æ®åº“éœ€è¦æ—¶é—´ï¼ˆå¼‚æ­¥æ“ä½œï¼‰
 * - ä½¿ç”¨ async/await è®©ä»£ç æ›´æ¸…æ™°ï¼Œé¿å…å›è°ƒåœ°ç‹±
 */
const startServer = async () => {
  try {
    /**
     * æ­¥éª¤ 1ï¼šè¿æ¥æ•°æ®åº“
     * awaitï¼šç­‰å¾…æ•°æ®åº“è¿æ¥å®Œæˆåå†ç»§ç»­
     * å¦‚æœè¿æ¥å¤±è´¥ï¼Œä¼šæŠ›å‡ºé”™è¯¯ï¼Œè¢« catch æ•è·
     */
    await connectDatabase();

    /**
     * æ­¥éª¤ 2ï¼šå¯åŠ¨ HTTP æœåŠ¡å™¨
     *
     * app.listen() è¯´æ˜ï¼š
     * - ç›‘å¬æŒ‡å®šç«¯å£ï¼Œæ¥æ”¶ HTTP è¯·æ±‚
     * - env.PORTï¼šä»ç¯å¢ƒå˜é‡è·å–ç«¯å£å·
     * - å›è°ƒå‡½æ•°ï¼šæœåŠ¡å™¨å¯åŠ¨æˆåŠŸåæ‰§è¡Œ
     *
     * server å˜é‡è¯´æ˜ï¼š
     * - ä¿å­˜æœåŠ¡å™¨å®ä¾‹ï¼Œåç»­ç”¨äºä¼˜é›…å…³é—­
     * - server.close()ï¼šåœæ­¢æ¥æ”¶æ–°è¯·æ±‚ï¼Œç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ
     */
    const server = app.listen(env.PORT, () => {
      // ä½¿ç”¨ logger è®°å½•å¯åŠ¨ä¿¡æ¯ï¼ˆè€Œä¸æ˜¯ console.logï¼‰
      logger.info(`ğŸš€ Server is running on http://localhost:${env.PORT}`);
      logger.info(`ğŸ“ Environment: ${env.NODE_ENV}`);
    });

    /**
     * ============ ä¼˜é›…å…³é—­æœºåˆ¶ ============
     */

    /**
     * ä¼˜é›…å…³é—­å‡½æ•°
     *
     * ä»€ä¹ˆæ˜¯ä¼˜é›…å…³é—­ï¼Ÿ
     * - æ”¶åˆ°åœæ­¢ä¿¡å·åï¼Œä¸ç«‹å³ç»ˆæ­¢è¿›ç¨‹
     * - å…ˆåœæ­¢æ¥æ”¶æ–°è¯·æ±‚ï¼Œç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ
     * - å…³é—­æ•°æ®åº“è¿æ¥ï¼Œé‡Šæ”¾èµ„æº
     * - æœ€åæ‰é€€å‡ºè¿›ç¨‹
     *
     * ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
     * - é¿å…æ­£åœ¨å¤„ç†çš„è¯·æ±‚è¢«å¼ºåˆ¶ä¸­æ–­
     * - é˜²æ­¢æ•°æ®åº“äº‹åŠ¡ä¸¢å¤±
     * - ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
     *
     * @param signal - æ¥æ”¶åˆ°çš„ä¿¡å·åç§°ï¼ˆSIGTERM æˆ– SIGINTï¼‰
     */
    const gracefulShutdown = async (signal: string) => {
      logger.info(`${signal} received, shutting down gracefully...`);

      /**
       * å…³é—­ HTTP æœåŠ¡å™¨
       *
       * server.close() è¯´æ˜ï¼š
       * - åœæ­¢æ¥æ”¶æ–°çš„è¿æ¥
       * - ç­‰å¾…æ‰€æœ‰ç°æœ‰è¿æ¥å®Œæˆ
       * - å®Œæˆåæ‰§è¡Œå›è°ƒå‡½æ•°
       */
      server.close(async () => {
        // æ–­å¼€æ•°æ®åº“è¿æ¥
        await disconnectDatabase();

        logger.info('Server closed');

        // æ­£å¸¸é€€å‡ºï¼ŒçŠ¶æ€ç  0 è¡¨ç¤ºæˆåŠŸ
        process.exit(0);
      });

      /**
       * å¼ºåˆ¶å…³é—­è¶…æ—¶
       *
       * ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶ï¼Ÿ
       * - å¦‚æœæœ‰è¯·æ±‚ä¸€ç›´ä¸ç»“æŸï¼Œä¼šå¯¼è‡´æ— æ³•å…³é—­
       * - è®¾ç½® 10 ç§’è¶…æ—¶ï¼Œè¶…æ—¶åå¼ºåˆ¶é€€å‡º
       *
       * setTimeout() è¯´æ˜ï¼š
       * - å»¶è¿Ÿæ‰§è¡Œå‡½æ•°
       * - 10000 æ¯«ç§’ = 10 ç§’
       */
      setTimeout(() => {
        logger.error('Forced shutdown after timeout');
        // å¼ºåˆ¶é€€å‡ºï¼ŒçŠ¶æ€ç  1 è¡¨ç¤ºå¼‚å¸¸é€€å‡º
        process.exit(1);
      }, 10000);
    };

    /**
     * ============ ç›‘å¬è¿›ç¨‹ä¿¡å· ============
     */

    /**
     * ç›‘å¬ SIGTERM ä¿¡å·
     *
     * ä»€ä¹ˆæ˜¯ SIGTERMï¼Ÿ
     * - SIGTERMï¼šTermination Signalï¼ˆç»ˆæ­¢ä¿¡å·ï¼‰
     * - ç”¨äºè¯·æ±‚è¿›ç¨‹ä¼˜é›…åœ°ç»ˆæ­¢
     * - ä¾‹å¦‚ï¼šDocker å®¹å™¨åœæ­¢æ—¶å‘é€æ­¤ä¿¡å·
     *
     * process.on() è¯´æ˜ï¼š
     * - ç›‘å¬è¿›ç¨‹äº‹ä»¶
     * - å½“æ”¶åˆ° SIGTERM ä¿¡å·æ—¶ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°
     */
    process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));

    /**
     * ç›‘å¬ SIGINT ä¿¡å·
     *
     * ä»€ä¹ˆæ˜¯ SIGINTï¼Ÿ
     * - SIGINTï¼šInterrupt Signalï¼ˆä¸­æ–­ä¿¡å·ï¼‰
     * - ç”¨æˆ·æŒ‰ Ctrl+C æ—¶å‘é€æ­¤ä¿¡å·
     * - ç”¨äºåœ¨å¼€å‘ç¯å¢ƒä¸­åœæ­¢æœåŠ¡å™¨
     */
    process.on('SIGINT', () => gracefulShutdown('SIGINT'));
  } catch (error) {
    /**
     * æ•è·å¯åŠ¨è¿‡ç¨‹ä¸­çš„ä»»ä½•é”™è¯¯
     * - æ•°æ®åº“è¿æ¥å¤±è´¥
     * - ç«¯å£è¢«å ç”¨
     * - ç­‰ç­‰...
     */
    logger.error('Failed to start server:', error);
    // å¼‚å¸¸é€€å‡º
    process.exit(1);
  }
};

/**
 * ============ æ‰§è¡Œå¯åŠ¨å‡½æ•° ============
 */

/**
 * è°ƒç”¨å¯åŠ¨å‡½æ•°
 * å¼€å§‹æ•´ä¸ªåº”ç”¨ç¨‹åºçš„å¯åŠ¨æµç¨‹
 */
startServer();
