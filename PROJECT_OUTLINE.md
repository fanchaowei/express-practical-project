# 项目大纲文档

## 一、项目概述

### 1.1 项目定位
本项目是一个基于 Express + Prisma 的企业级后台管理系统，采用模块化设计，支持多子系统扩展。系统以影片收藏管理为首个子系统，后续可灵活添加其他业务模块。

### 1.2 项目特点
- **模块化架构**：每个子系统独立开发、独立部署，互不干扰
- **易扩展性**：新增子系统只需添加对应的模块和菜单配置
- **企业级规范**：遵循中小型企业项目的最佳实践和代码规范
- **类型安全**：使用 TypeScript 提供完整的类型检查和开发体验

---

## 二、技术栈

### 2.1 核心技术栈

#### 后端框架
- **Node.js** (v18+)：运行时环境
- **Express.js** (v4.x)：Web 应用框架
- **TypeScript** (v5.x)：类型安全的 JavaScript 超集

#### 数据库相关
- **PostgreSQL** (v15+)：关系型数据库
- **Prisma** (v5.x)：现代化 ORM 工具
  - Prisma Client：类型安全的数据库客户端
  - Prisma Migrate：数据库迁移工具
  - Prisma Studio：数据库可视化管理工具

#### 容器化
- **Docker**：容器化部署
- **Docker Compose**：多容器编排

### 2.2 开发工具链

#### 代码质量
- **ESLint**：代码规范检查
- **Prettier**：代码格式化
- **Husky**：Git hooks 管理
- **lint-staged**：暂存区代码检查

#### 测试框架
- **Jest**：单元测试框架
- **Supertest**：API 集成测试

### 2.3 核心依赖库

#### 身份认证与授权
- **jsonwebtoken (JWT)**：Token 生成与验证
- **bcrypt**：密码加密
- **express-rate-limit**：接口限流

#### 数据验证
- **Zod** 或 **Joi**：请求参数验证

#### 日志管理
- **Winston** 或 **Pino**：结构化日志记录

#### 文件上传
- **Multer**：文件上传中间件
- **Sharp**：图片处理（压缩、裁剪）

#### 工具库
- **dotenv**：环境变量管理
- **cors**：跨域资源共享
- **helmet**：安全头部设置
- **compression**：响应压缩

---

## 三、项目架构

### 3.1 整体架构模式

采用 **三层架构 + 模块化** 的设计模式：

```
┌─────────────────────────────────────────┐
│          API Layer (路由层)              │
│  - 接收请求                              │
│  - 参数验证                              │
│  - 调用控制器                            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│       Controller Layer (控制器层)        │
│  - 请求处理                              │
│  - 响应封装                              │
│  - 调用服务层                            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│        Service Layer (服务层)            │
│  - 业务逻辑处理                          │
│  - 数据处理                              │
│  - 调用数据访问层                        │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Data Access Layer (数据访问层)      │
│  - Prisma Client                         │
│  - 数据库操作                            │
└─────────────────────────────────────────┘
```

### 3.2 目录结构设计

```
practical-project/
├── src/
│   ├── app.ts                    # Express 应用配置
│   ├── server.ts                 # 应用启动入口
│   │
│   ├── config/                   # 配置文件
│   │   ├── env.ts                # 环境变量配置
│   │   ├── database.ts           # 数据库配置
│   │   └── jwt.ts                # JWT 配置
│   │
│   ├── modules/                  # 业务模块（按功能划分）
│   │   ├── auth/                 # 认证模块
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.service.ts
│   │   │   ├── auth.route.ts
│   │   │   ├── auth.validation.ts
│   │   │   └── auth.interface.ts
│   │   │
│   │   ├── user/                 # 用户模块
│   │   │   ├── user.controller.ts
│   │   │   ├── user.service.ts
│   │   │   ├── user.route.ts
│   │   │   ├── user.validation.ts
│   │   │   └── user.interface.ts
│   │   │
│   │   └── media/                # 影片收藏模块
│   │       ├── media.controller.ts
│   │       ├── media.service.ts
│   │       ├── media.route.ts
│   │       ├── media.validation.ts
│   │       └── media.interface.ts
│   │
│   ├── middlewares/              # 中间件
│   │   ├── auth.middleware.ts    # 身份验证中间件
│   │   ├── error.middleware.ts   # 错误处理中间件
│   │   ├── validation.middleware.ts  # 参数验证中间件
│   │   └── upload.middleware.ts  # 文件上传中间件
│   │
│   ├── utils/                    # 工具函数
│   │   ├── response.ts           # 统一响应格式
│   │   ├── error.ts              # 自定义错误类
│   │   ├── logger.ts             # 日志工具
│   │   └── prisma.ts             # Prisma Client 单例
│   │
│   └── types/                    # TypeScript 类型定义
│       ├── express.d.ts          # Express 扩展类型
│       └── common.ts             # 通用类型定义
│
├── prisma/
│   ├── schema.prisma             # Prisma 数据模型
│   ├── migrations/               # 数据库迁移文件
│   └── seed.ts                   # 数据库种子数据
│
├── tests/                        # 测试文件
│   ├── unit/                     # 单元测试
│   └── integration/              # 集成测试
│
├── uploads/                      # 文件上传目录
│
├── docker-compose.yml            # Docker 编排配置
├── Dockerfile                    # Docker 镜像配置
├── .env.example                  # 环境变量示例
├── .gitignore
├── package.json
├── tsconfig.json                 # TypeScript 配置
├── .eslintrc.js                  # ESLint 配置
├── .prettierrc                   # Prettier 配置
└── README.md
```

---

## 四、项目需求细分

### 4.1 基础功能模块

#### 4.1.1 用户认证与授权模块
**功能范围：**
- 用户注册
  - 用户名、邮箱、密码注册
  - 密码强度验证
  - 邮箱唯一性验证

- 用户登录
  - 用户名/邮箱 + 密码登录
  - 登录失败次数限制
  - JWT Token 生成与返回

- Token 管理
  - Access Token（短期有效）
  - Refresh Token（长期有效）
  - Token 刷新机制

- 权限控制
  - 基于角色的访问控制（RBAC）
  - 路由级别的权限验证
  - 资源级别的权限验证

#### 4.1.2 用户管理模块
**功能范围：**
- 用户信息管理
  - 获取当前用户信息
  - 更新用户资料
  - 修改密码

- 用户列表管理（管理员）
  - 用户列表查询
  - 用户状态管理（启用/禁用）
  - 用户角色分配

### 4.2 影片收藏子系统

#### 4.2.1 影片管理模块
**功能范围：**
- 影片添加
  - 基本信息：标题、类型、上映年份、评分
  - 扩展信息：导演、演员、简介、评语
  - 标签管理：支持多标签
  - 图片上传：支持多图上传，指定封面图

- 影片编辑
  - 更新影片基本信息
  - 更新标签
  - 更新图片（新增/删除/更换封面）

- 影片删除
  - 软删除机制
  - 关联数据清理

- 影片详情查询
  - 获取完整影片信息
  - 包含所有图片和标签

#### 4.2.2 影片检索模块
**功能范围：**
- 多维度筛选
  - 按类型筛选（电影/电视剧/番剧/动画电影）
  - 按评分范围筛选
  - 按标签筛选（支持多标签组合）
  - 按上映年份筛选（年份区间）

- 搜索功能
  - 标题模糊搜索
  - 导演/演员搜索

- 排序功能
  - 按评分排序
  - 按上映年份排序
  - 按添加时间排序

- 分页功能
  - 支持自定义每页数量
  - 返回总数和分页信息

#### 4.2.3 标签管理模块
**功能范围：**
- 标签 CRUD
  - 创建标签
  - 标签列表查询
  - 标签更新
  - 标签删除（检查关联）

- 标签统计
  - 标签使用频率统计
  - 热门标签推荐

### 4.3 系统管理模块

#### 4.3.1 菜单管理
**功能范围：**
- 动态菜单配置
  - 菜单树结构管理
  - 菜单与模块关联
  - 菜单权限配置

- 菜单查询
  - 根据用户角色返回可访问菜单
  - 菜单树形结构返回

#### 4.3.2 文件管理
**功能范围：**
- 文件上传
  - 图片格式验证
  - 文件大小限制
  - 图片压缩处理

- 文件存储
  - 本地存储（初期）
  - 云存储扩展接口（预留）

- 文件访问
  - 静态资源服务
  - 访问权限控制

---

## 五、从零搭建项目骨架流程

### 5.1 环境准备阶段

#### 步骤 1：开发环境安装
- 安装 Node.js (v18+)
- 安装 Docker 和 Docker Compose
- 安装 PostgreSQL 客户端工具（可选）
- 安装代码编辑器（VS Code 推荐）

#### 步骤 2：项目初始化
- 创建项目目录
- 初始化 npm 项目 (`npm init`)
- 初始化 Git 仓库
- 创建 `.gitignore` 文件

### 5.2 基础配置阶段

#### 步骤 3：TypeScript 配置
- 安装 TypeScript 及相关依赖
- 创建 `tsconfig.json` 配置文件
- 配置编译选项和路径别名

#### 步骤 4：代码规范配置
- 安装并配置 ESLint
- 安装并配置 Prettier
- 配置 Husky 和 lint-staged
- 创建 `.eslintrc.js` 和 `.prettierrc`

#### 步骤 5：环境变量配置
- 安装 dotenv
- 创建 `.env.example` 模板
- 创建 `.env` 文件（本地开发）
- 配置环境变量加载逻辑

### 5.3 数据库搭建阶段

#### 步骤 6：Docker 环境配置
- 编写 `docker-compose.yml`
- 配置 PostgreSQL 服务
- 启动数据库容器
- 验证数据库连接

#### 步骤 7：Prisma 初始化
- 安装 Prisma CLI 和 Client
- 初始化 Prisma (`npx prisma init`)
- 配置数据库连接字符串
- 创建 Prisma Client 单例工具

### 5.4 项目结构搭建阶段

#### 步骤 8：创建目录结构
- 创建 `src/` 主目录
- 创建各子目录（config、modules、middlewares、utils、types）
- 创建 `tests/` 测试目录
- 创建 `uploads/` 上传目录

#### 步骤 9：Express 应用初始化
- 安装 Express 及类型定义
- 创建 `app.ts`（Express 应用配置）
- 创建 `server.ts`（应用启动入口）
- 配置基础中间件（cors、helmet、compression 等）

### 5.5 核心功能搭建阶段

#### 步骤 10：工具函数开发
- 创建统一响应格式工具
- 创建自定义错误类
- 创建日志工具
- 创建常用工具函数

#### 步骤 11：中间件开发
- 创建全局错误处理中间件
- 创建参数验证中间件
- 创建日志记录中间件
- 创建请求限流中间件

#### 步骤 12：数据模型设计
- 设计用户表模型
- 设计角色权限模型
- 设计影片相关模型
- 编写 `schema.prisma`

#### 步骤 13：数据库迁移
- 执行首次迁移 (`prisma migrate dev`)
- 验证数据库表结构
- 编写种子数据脚本（可选）

### 5.6 业务模块开发阶段

#### 步骤 14：认证模块开发
- 创建认证模块目录结构
- 实现用户注册功能
- 实现用户登录功能
- 实现 JWT Token 生成与验证
- 创建认证中间件

#### 步骤 15：用户模块开发
- 创建用户模块目录结构
- 实现用户信息查询
- 实现用户信息更新
- 实现密码修改功能

#### 步骤 16：影片模块开发
- 创建影片模块目录结构
- 实现影片 CRUD 功能
- 实现图片上传功能
- 实现标签管理功能
- 实现筛选和搜索功能

#### 步骤 17：菜单模块开发
- 创建菜单模块目录结构
- 实现菜单配置功能
- 实现动态菜单查询
- 实现权限关联

### 5.7 测试与优化阶段

#### 步骤 18：测试环境搭建
- 安装测试框架（Jest、Supertest）
- 配置测试环境
- 创建测试数据库

#### 步骤 19：编写测试用例
- 编写单元测试
- 编写集成测试
- 编写 API 端到端测试

#### 步骤 20：性能优化
- 数据库查询优化
- 添加数据库索引
- 实现缓存机制（可选）
- 接口响应时间优化

### 5.8 部署准备阶段

#### 步骤 21：Docker 镜像构建
- 编写 `Dockerfile`
- 优化镜像大小
- 配置多阶段构建

#### 步骤 22：生产环境配置
- 配置生产环境变量
- 配置日志输出
- 配置错误监控
- 配置健康检查接口

#### 步骤 23：文档编写
- 编写 API 文档
- 编写部署文档
- 编写开发指南
- 更新 README

---

## 六、开发规范

### 6.1 代码规范
- 遵循 ESLint 和 Prettier 配置
- 使用 TypeScript 严格模式
- 统一的命名规范（驼峰、帕斯卡等）
- 代码注释规范（JSDoc）

### 6.2 Git 规范
- 分支管理策略（main、develop、feature）
- Commit 信息规范（Conventional Commits）
- Pull Request 流程

### 6.3 API 规范
- RESTful API 设计原则
- 统一的响应格式
- 统一的错误码定义
- API 版本管理

### 6.4 安全规范
- 密码加密存储
- SQL 注入防护（Prisma 自动防护）
- XSS 防护
- CSRF 防护
- 接口限流
- 敏感信息脱敏

---

## 七、后续扩展规划

### 7.1 功能扩展
- 新增其他子系统模块
- 实现数据导出功能
- 实现数据统计和可视化
- 实现消息通知功能

### 7.2 技术扩展
- 引入 Redis 缓存
- 引入消息队列（Bull、RabbitMQ）
- 引入全文搜索（Elasticsearch）
- 引入云存储服务（OSS、S3）

### 7.3 性能扩展
- 数据库读写分离
- 负载均衡
- CDN 加速
- 微服务拆分（长期）

---

## 八、参考资源

### 技术文档
- [Express.js 官方文档](https://expressjs.com/)
- [Prisma 官方文档](https://www.prisma.io/docs)
- [PostgreSQL 官方文档](https://www.postgresql.org/docs/)
- [TypeScript 官方文档](https://www.typescriptlang.org/docs/)

### 最佳实践参考
- Node.js 最佳实践指南
- Express 企业级项目架构
- Prisma 性能优化指南
- RESTful API 设计规范

---

**文档版本：** v1.0
**最后更新：** 2026-02-03
**维护者：** 项目开发团队
